<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Coarse-Grained Polymer &#8212; OpenMM Cookbook &amp; Tutorials dev documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=a0d4cc31" />
    <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />
    <link rel="stylesheet" type="text/css" href="../../_static/notebooks.css?v=9b8a9a20" />
    <script src="../../_static/documentation_options.js?v=3ce10a4d"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Alchemical free energy calculations" href="Alchemical_free_energy_calculations.html" />
    <link rel="prev" title="Selecting Values for Simulation Parameters" href="simulation_parameters.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="nbsphinx-prolog">
    <a href="coarse_grained_polymer.ipynb">Download Notebook</a>
    <a href="https://github.com/openmm/openmm-cookbook/blob/main/notebooks/tutorials/coarse_grained_polymer.ipynb">View in GitHub</a>
    <a href="https://colab.research.google.com/github/openmm/openmm-cookbook/blob/gh-pages/dev/colab/notebooks/tutorials/coarse_grained_polymer.ipynb">Open in Google Colab</a>
</div><span class="target" id="index-0"></span><section id="Coarse-Grained-Polymer">
<h1>Coarse-Grained Polymer<a class="headerlink" href="#Coarse-Grained-Polymer" title="Link to this heading">¶</a></h1>
<p>This tutorial will give a basic example of creating a custom coarse-grained model in OpenMM. First it will demonstrate how to setup a molecular topology from scratch using the Python API. Next it will cover two methods for defining a custom forcefield:</p>
<ol class="arabic simple">
<li><p>Using the Python API</p></li>
<li><p>Creating a forcefield xml file.</p></li>
</ol>
<p>It assumes you are familiar with the concept of coarse-graining and want to learn how to implement your CG model in OpenMM.</p>
<section id="Example-System">
<h2>Example System<a class="headerlink" href="#Example-System" title="Link to this heading">¶</a></h2>
<p>The example system in this tutorial is a Lennard-Jones bead-spring polymer model. We will demonstrate how to create a polymer melt of multiple chains. Note that we will set the bond lengths, particle mass, and Lennard-Jones interaction parameters to physical values that are typical of a residue level coarse-grained protein model (e.g. [1]).</p>
</section>
<section id="Creating-CG-Topology">
<h2>Creating CG Topology<a class="headerlink" href="#Creating-CG-Topology" title="Link to this heading">¶</a></h2>
<p>To demonstrate the full flexibility of OpenMM we will use the Python API to define the topology. Note that you could create a PDB file and read that in instead.</p>
<p>First we do the usual imports for OpenMM.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">openmm</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">openmm.app</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">app</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">openmm.unit</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">unit</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sys</span><span class="w"> </span><span class="kn">import</span> <span class="n">stdout</span>
</pre></div>
</div>
</div>
<p>We can create a new element to represent our CG bead. We set the atomic index to a large number, however the actual value is unimportant in this simulation and is just used for book-keeping purposes. We set the mass to approximate the molar mass of an amino-acid. The mass we define is important as it needs to be consistent with the chosen integration timestep.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="n">cgElement</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;CG-element&#39;</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We then create an empty <code class="docutils literal notranslate"><span class="pre">Topology</span></code> object.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make an empty topology</span>
<span class="n">topology</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">Topology</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Now we can create our simulation topology using python scripting. We will define <code class="docutils literal notranslate"><span class="pre">M</span> <span class="pre">=</span> <span class="pre">100</span></code> polymer chains which each have <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">=</span> <span class="pre">10</span></code> beads. As we loop over the atoms in each chain we also record the list of bonds.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Number of polymer chains</span>
<span class="n">M</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># Number of atoms in each chain</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># Add each chain to the topology</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>

    <span class="c1"># Make the chain</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">topology</span><span class="o">.</span><span class="n">addChain</span><span class="p">()</span>

    <span class="c1"># Create the first residue in the chain</span>
    <span class="n">residue</span> <span class="o">=</span> <span class="n">topology</span><span class="o">.</span><span class="n">addResidue</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;CG-residue&quot;</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="n">chain</span><span class="p">)</span>

    <span class="c1"># In this example each residue is one bead so we add a single atom</span>
    <span class="n">atom1</span> <span class="o">=</span> <span class="n">topology</span><span class="o">.</span><span class="n">addAtom</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;CG-bead&quot;</span><span class="p">,</span> <span class="n">element</span><span class="o">=</span><span class="n">cgElement</span><span class="p">,</span> <span class="n">residue</span><span class="o">=</span><span class="n">residue</span><span class="p">)</span>

    <span class="c1"># Now add the rest of residues in the chain</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">residue</span> <span class="o">=</span> <span class="n">topology</span><span class="o">.</span><span class="n">addResidue</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;CG-residue&quot;</span><span class="p">,</span><span class="n">chain</span><span class="o">=</span><span class="n">chain</span><span class="p">)</span>
        <span class="n">atom2</span> <span class="o">=</span> <span class="n">topology</span><span class="o">.</span><span class="n">addAtom</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;CG-bead&quot;</span><span class="p">,</span> <span class="n">element</span><span class="o">=</span><span class="n">cgElement</span><span class="p">,</span> <span class="n">residue</span><span class="o">=</span><span class="n">residue</span><span class="p">)</span>

        <span class="c1"># add the bonds in as we go</span>
        <span class="n">topology</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">)</span>
        <span class="n">atom1</span> <span class="o">=</span> <span class="n">atom2</span>

<span class="c1"># check the topology</span>
<span class="nb">print</span><span class="p">(</span><span class="n">topology</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Define-the-initial-positions">
<h2>Define the initial positions<a class="headerlink" href="#Define-the-initial-positions" title="Link to this heading">¶</a></h2>
<p>As we have created the topology from scratch we will also need to define the initial positions from scratch. We will arrange our 100 polymer chains in a 10x10 grid in the X,Y plane and each polymer will be in a linear configuration in the Z direction. Furthermore, we set the simulation box to be cubic with length 11nm.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(((</span><span class="n">m</span><span class="o">%</span><span class="k">10</span>)*1.0, (m//10)*1.0, 0))
    <span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.38</span><span class="p">))</span>
        <span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>

<span class="c1"># Convert the list into OpenMM Quantity with units of nm</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">positions</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span>
<span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span> <span class="o">==</span> <span class="n">topology</span><span class="o">.</span><span class="n">getNumAtoms</span><span class="p">())</span>

<span class="c1"># Set the box to be a cube with length 11nm</span>
<span class="n">topology</span><span class="o">.</span><span class="n">setPeriodicBoxVectors</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mf">11.0</span><span class="o">*</span><span class="n">unit</span><span class="o">.</span><span class="n">nanometers</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can check the initial topology by saving it to a PDB file.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># output the initial configuration</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;initial_config.pdb&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">PDBFile</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The initial configuration looks like this: <img alt="initial configuration" src="../../_images/initial_config.png" /></p>
</section>
<section id="Defining-the-force-field">
<h2>Defining the force field<a class="headerlink" href="#Defining-the-force-field" title="Link to this heading">¶</a></h2>
<p>We will cover two methods for defining the forcefield:</p>
<ol class="arabic simple">
<li><p>Using the Python API.</p></li>
<li><p>Creating a forcefield xml file.</p></li>
</ol>
<p>Both methods achieve the same result of defining the forcefield. There are pros and cons of both ways. The key points are that using the Python API is more flexible, while creating a forcefield xml file makes it easier to share your forcefield and helps reproducibility. This is demonstrated in the other OpenMM tutorials — the standard forcefields such as Amber are distributed with OpenMM as xml files, while the custom forces used to do free energy calculations are defined using the Python API.</p>
</section>
<section id="Defining-a-force-field-using-the-Python-API">
<h2>Defining a force-field using the Python API<a class="headerlink" href="#Defining-a-force-field-using-the-Python-API" title="Link to this heading">¶</a></h2>
<p>We can create instances of the OpenMM <a class="reference external" href="http://docs.openmm.org/latest/api-python/library.html#forces">Force classes</a>, assign parameters, and add them to the system. First we must create a <a class="reference external" href="http://docs.openmm.org/latest/api-python/generated/openmm.openmm.System.html#openmm.openmm.System">System</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create the system and add the particles to it</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">System</span><span class="p">()</span>
<span class="n">system</span><span class="o">.</span><span class="n">setDefaultPeriodicBoxVectors</span><span class="p">(</span><span class="o">*</span><span class="n">topology</span><span class="o">.</span><span class="n">getPeriodicBoxVectors</span><span class="p">())</span>
<span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">topology</span><span class="o">.</span><span class="n">atoms</span><span class="p">():</span>
    <span class="n">system</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We will then create a <a class="reference external" href="http://docs.openmm.org/latest/api-python/generated/openmm.openmm.HarmonicBondForce.html#openmm.openmm.HarmonicBondForce">HarmonicBondForce</a> and a <a class="reference external" href="http://docs.openmm.org/latest/api-python/generated/openmm.openmm.CustomNonbondedForce.html#openmm.openmm.CustomNonbondedForce">CustomNonBondedForce</a>.</p>
<p>For each bond that is defined in the topology we need to add it to the <code class="docutils literal notranslate"><span class="pre">HarmonicBondForce</span></code>. We set the equilibrium bond lengths and spring constants to be 0.38 nm and 1000 kJ/mol/nm respectively which are consistent with parameters used in amino-acid level CG models [1].</p>
<p>We define the <code class="docutils literal notranslate"><span class="pre">CustomNonBondedForce</span></code> to be a Lennard-Jones interaction. We set the value of sigma to be 0.5nm to approximate the size of an amino acid and the value of epsilon to 1 kJ/mol to create a potential that is attractive at 300K. Please do not use these parameters for real simulations. You should consult the literature and choose an appropriate CG force-field or systematically create your own parameter set! Finally, we add exclusions between atoms that are directly bonded and set a
cutoff of 1.5nm.</p>
<p>Note that because we have defined a Lennard-Jones potential we could have used the standard <code class="docutils literal notranslate"><span class="pre">`NonBondedForce</span></code> &lt;<a class="reference external" href="http://docs.openmm.org/latest/api-python/generated/openmm.openmm.NonbondedForce.html#openmm.openmm.NonbondedForce">http://docs.openmm.org/latest/api-python/generated/openmm.openmm.NonbondedForce.html#openmm.openmm.NonbondedForce</a>&gt;`__, but to demonstrate the flexibility to use different user defined potentials we have used <code class="docutils literal notranslate"><span class="pre">CustomNonBondedForce</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">harmonic_bond_force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">HarmonicBondForce</span><span class="p">()</span>

<span class="c1"># Add each bond to the force from the topology</span>
<span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">topology</span><span class="o">.</span><span class="n">bonds</span><span class="p">():</span>
    <span class="n">harmonic_bond_force</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mf">0.38</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="c1"># Define a Lennard-Jones potential</span>
<span class="n">expression</span> <span class="o">=</span> <span class="s1">&#39;4*epsilon*((sigma/r)^12-(sigma/r)^6);&#39;</span>\
            <span class="o">+</span> <span class="s1">&#39; sigma=0.5*(sigma1+sigma2);&#39;</span>\
            <span class="o">+</span> <span class="s1">&#39; epsilon=sqrt(epsilon1*epsilon2)&#39;</span>

<span class="n">custom_nb_force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

<span class="n">custom_nb_force</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">)</span>
<span class="n">custom_nb_force</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s1">&#39;epsilon&#39;</span><span class="p">)</span>

<span class="c1"># Add the parameters for each particle</span>
<span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">topology</span><span class="o">.</span><span class="n">atoms</span><span class="p">():</span>
    <span class="n">custom_nb_force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>

<span class="c1"># Create exclusions for directly bonded atoms</span>
<span class="n">custom_nb_force</span><span class="o">.</span><span class="n">createExclusionsFromBonds</span><span class="p">([(</span><span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">topology</span><span class="o">.</span><span class="n">bonds</span><span class="p">()],</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Set a cutoff of 1.5nm</span>
<span class="n">custom_nb_force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">)</span>
<span class="n">custom_nb_force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">unit</span><span class="o">.</span><span class="n">nanometers</span><span class="p">)</span>

<span class="c1"># Add the forces to the system</span>
<span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">harmonic_bond_force</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">custom_nb_force</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<p>The system is now ready to simulate. Before we run the simulation we will describe the other method of defining a forcefield by creating a custom forcefield xml file.</p>
</section>
<section id="Creating-a-force-field-xml-file">
<h2>Creating a force-field xml file<a class="headerlink" href="#Creating-a-force-field-xml-file" title="Link to this heading">¶</a></h2>
<p>Alternatively, we can create a custom force-field xml file for our system. You should look here first for the full information: <a class="reference external" href="http://docs.openmm.org/latest/userguide/application/05_creating_ffs.html">http://docs.openmm.org/latest/userguide/application/05_creating_ffs.html</a>.</p>
<p>You will need to create a new file called “cg_ff.xml” using a text editor of your choice. Then paste the following lines into it:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- cg_ff.xml</span>
<span class="cm">Coarse-grained forcefield for a bead-spring polymer. --&gt;</span>
<span class="nt">&lt;ForceField&gt;</span>

<span class="w">    </span><span class="nt">&lt;AtomTypes&gt;</span>
<span class="w">        </span><span class="nt">&lt;Type</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;CG-bead&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;CG-bead&quot;</span><span class="w"> </span><span class="na">element=</span><span class="s">&quot;CG&quot;</span><span class="w"> </span><span class="na">mass=</span><span class="s">&quot;120.0&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/AtomTypes&gt;</span>

<span class="w">    </span><span class="nt">&lt;Residues&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- Each bead is a single residue.</span>
<span class="cm">        Need a template for the different Residue types.</span>
<span class="cm">        First type is the end. This only has one bond. --&gt;</span>
<span class="w">        </span><span class="nt">&lt;Residue</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;CG-residue-end&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;Atom</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;CG-bead&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;CG-bead&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;ExternalBond</span><span class="w"> </span><span class="na">atomName=</span><span class="s">&quot;CG-bead&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Residue&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- Second type is in the middle of the chain. This has two bonds. --&gt;</span>
<span class="w">        </span><span class="nt">&lt;Residue</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;CG-residue-middle&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;Atom</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;CG-bead&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;CG-bead&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;ExternalBond</span><span class="w"> </span><span class="na">atomName=</span><span class="s">&quot;CG-bead&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;ExternalBond</span><span class="w"> </span><span class="na">atomName=</span><span class="s">&quot;CG-bead&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Residue&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Residues&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- Define a harmonic bond between the CA-beads --&gt;</span>
<span class="w">    </span><span class="nt">&lt;HarmonicBondForce&gt;</span>
<span class="w">        </span><span class="nt">&lt;Bond</span><span class="w"> </span><span class="na">class1=</span><span class="s">&quot;CG-bead&quot;</span><span class="w"> </span><span class="na">class2=</span><span class="s">&quot;CG-bead&quot;</span><span class="w"> </span><span class="na">length=</span><span class="s">&quot;0.38&quot;</span><span class="w"> </span><span class="na">k=</span><span class="s">&quot;1000.0&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/HarmonicBondForce&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- Use a custom non-bonded force for maximum flexibility.</span>
<span class="cm">    The bondCutoff=1 tells it to only exclude interactions between directly bonded atoms. --&gt;</span>
<span class="w">    </span><span class="nt">&lt;CustomNonbondedForce</span><span class="w"> </span><span class="na">energy=</span><span class="s">&quot;4*epsilon*((sigma/r)^12-(sigma/r)^6); sigma=0.5*(sigma1+sigma2); epsilon=sqrt(epsilon1*epsilon2)&quot;</span><span class="w"> </span><span class="na">bondCutoff=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;PerParticleParameter</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;sigma&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;PerParticleParameter</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;epsilon&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;Atom</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;CG-bead&quot;</span><span class="w"> </span><span class="na">sigma=</span><span class="s">&quot;0.5&quot;</span><span class="w"> </span><span class="na">epsilon=</span><span class="s">&quot;1.0&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/CustomNonbondedForce&gt;</span>
<span class="nt">&lt;/ForceField&gt;</span>
</pre></div>
</div>
<p>(If you have cloned the cookbook repo then this file will already exist) The comments in the above code explain what the difference sections are for.</p>
<section id="Create-the-system">
<h3>Create the system<a class="headerlink" href="#Create-the-system" title="Link to this heading">¶</a></h3>
<p>We can now load in our previously created custom <code class="docutils literal notranslate"><span class="pre">ForceField</span></code> and use the <code class="docutils literal notranslate"><span class="pre">createSystem</span></code> method with the <code class="docutils literal notranslate"><span class="pre">topology</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load in the ForceField we created</span>
<span class="n">ff</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">ForceField</span><span class="p">(</span><span class="s1">&#39;./cg_ff.xml&#39;</span><span class="p">)</span>
<span class="n">system2</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="mf">1.5</span><span class="o">*</span><span class="n">unit</span><span class="o">.</span><span class="n">nanometers</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can compare the two systems to check if they are the same. A simple way to do this is to serialize the systems as save them as xml files.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;system1.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">XmlSerializer</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">system</span><span class="p">))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;system2.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">XmlSerializer</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">system2</span><span class="p">))</span>

<span class="o">!</span>diff<span class="w"> </span>system1.xml<span class="w"> </span>system2.xml
</pre></div>
</div>
</div>
<p>We actually find they are slightly different. <code class="docutils literal notranslate"><span class="pre">system2</span></code> created by <code class="docutils literal notranslate"><span class="pre">ForceField.createSystem</span></code> has a <code class="docutils literal notranslate"><span class="pre">CMMotionRemover</span></code> that was added by default when using the <code class="docutils literal notranslate"><span class="pre">createSystem</span></code> method. If we wanted to we could add this to the first system.</p>
</section>
</section>
<section id="Setup-and-run-the-simulation">
<h2>Setup and run the simulation<a class="headerlink" href="#Setup-and-run-the-simulation" title="Link to this heading">¶</a></h2>
<p>We will use a <code class="docutils literal notranslate"><span class="pre">LangevinMiddleIntegrator</span></code> with a friction term of 0.01ps^-1 and a timestep of 0.01ps as used in similar coarse-grained polymer models [1]. For your own models these parameters will be important and you will need to choose them carefully!</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">integrator</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">LangevinMiddleIntegrator</span><span class="p">(</span><span class="mi">300</span><span class="o">*</span><span class="n">unit</span><span class="o">.</span><span class="n">kelvin</span><span class="p">,</span> <span class="mf">0.01</span><span class="o">/</span><span class="n">unit</span><span class="o">.</span><span class="n">picosecond</span><span class="p">,</span> <span class="mf">0.010</span><span class="o">*</span><span class="n">unit</span><span class="o">.</span><span class="n">picoseconds</span><span class="p">)</span>
<span class="n">simulation</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">Simulation</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">)</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>

<span class="c1"># setup simulation reporters</span>
<span class="c1"># Write the trajectory to a file called &#39;traj.dcd&#39;</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">DCDReporter</span><span class="p">(</span><span class="s1">&#39;traj.dcd&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">enforcePeriodicBox</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Report information to the screen as the simulation runs</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">StateDataReporter</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">potentialEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">speed</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>


<span class="c1"># NVT equilibration</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>

<span class="c1"># Add a barostat</span>
<span class="n">barostatIndex</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">MonteCarloBarostat</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">unit</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="mi">300</span><span class="o">*</span><span class="n">unit</span><span class="o">.</span><span class="n">kelvin</span><span class="p">))</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">reinitialize</span><span class="p">(</span><span class="n">preserveState</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Run NPT equilibration</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>


<span class="c1"># output the equilibrated configuration</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;equilibrated_config.pdb&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getPositions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enforcePeriodicBox</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">topology</span><span class="o">.</span><span class="n">setPeriodicBoxVectors</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">getPeriodicBoxVectors</span><span class="p">())</span>
    <span class="n">app</span><span class="o">.</span><span class="n">PDBFile</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">getPositions</span><span class="p">(),</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The equilibrated system will be a polymer melt that looks similar to this: <img alt="equilibrated polymer melt" src="../../_images/equilibrated_config.png" /></p>
</section>
<section id="References">
<h2>References<a class="headerlink" href="#References" title="Link to this heading">¶</a></h2>
<p>[1] GL Dignon, W Zheng, YC Kim, RB Best, J Mittal, PLoS computational biology 14 (1), 2018. <a class="reference external" href="https://doi.org/10.1371/journal.pcbi.1005941">https://doi.org/10.1371/journal.pcbi.1005941</a></p>
</section>
</section>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="simulation_parameters.html" title="Previous document">Selecting Values for Simulation Parameters</a>
        </li>
        <li>
          <a href="Alchemical_free_energy_calculations.html" title="Next document">Alchemical free energy calculations</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo.svg" alt="Logo" />
    
    <h1 class="logo logo-name">OpenMM Cookbook & Tutorials</h1>
    
  </a>
</p>











<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><div class="navigation-scrollbox">
    <div class="nav-toctree">
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../cookbook.html">The OpenMM Cookbook</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../tutorials.html">The OpenMM Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../tutorials.html#getting-started">Getting Started</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../tutorials.html#beyond-the-basics">Beyond the Basics</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="simulation_parameters.html">Selecting Values for Simulation Parameters</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Coarse-Grained Polymer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Example-System">Example System</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Creating-CG-Topology">Creating CG Topology</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Define-the-initial-positions">Define the initial positions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Defining-the-force-field">Defining the force field</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Defining-a-force-field-using-the-Python-API">Defining a force-field using the Python API</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Creating-a-force-field-xml-file">Creating a force-field xml file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Setup-and-run-the-simulation">Setup and run the simulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#References">References</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="Alchemical_free_energy_calculations.html">Alchemical free energy calculations</a></li>
<li class="toctree-l3"><a class="reference internal" href="Beta_2_adrenergic_receptor_B2AR_membrane_protein_simulation_with_CHARMM.html">Beta-2-adrenergic receptor (B2AR) membrane protein simulation with CHARMM</a></li>
<li class="toctree-l3"><a class="reference internal" href="HSP90_with_ADPMg2_simulation.html">HSP90 with ADP:Mg2+ simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="Histone_methyltransferase_simulation_with_a_multisite_water_model_TIP4P-Ew.html">Histone methyltransferase simulation with a multisite water model (TIP4P-Ew)</a></li>
<li class="toctree-l3"><a class="reference internal" href="Histone_methyltransferase_simulation_with_multisite_Zn2_structural_ions.html">Histone methyltransferase simulation with multisite Zn2+ structural ions</a></li>
<li class="toctree-l3"><a class="reference internal" href="Running_a_REST_simulation.html">Run a REST simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="umbrella_sampling.html">Umbrella Sampling</a></li>
</ul>
</li>
</ul>
</li>
</ul>

    </div>
    
    <ul class="extra-nav-links">
        
        <li class="toctree-l1">
            <a href="https://openmm.org">
                OpenMM.org
            </a>
        </li>
        
        <li class="toctree-l1">
            <a href="https://docs.openmm.org/latest/userguide/">
                User's Manual
            </a>
        </li>
        
        <li class="toctree-l1">
            <a href="https://docs.openmm.org/latest/developerguide/">
                Developer Guide
            </a>
        </li>
        
        <li class="toctree-l1">
            <a href="https://docs.openmm.org/latest/api-c++/">
                C++ API reference
            </a>
        </li>
        
        <li class="toctree-l1">
            <a href="https://docs.openmm.org/latest/api-python/">
                Python API reference
            </a>
        </li>
        
        <li class="toctree-l1">
            <a href="https://github.com/openmm/openmm">
                GitHub
            </a>
        </li>
        
    </ul>
    
</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, The OpenMM Contributors.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../../_sources/notebooks/tutorials/coarse_grained_polymer.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>