<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Loading Input Files and Reporting Results &#8212; OpenMM Cookbook &amp; Tutorials dev documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=a0d4cc31" />
    <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />
    <link rel="stylesheet" type="text/css" href="../../_static/notebooks.css?v=9b8a9a20" />
    <script src="../../_static/documentation_options.js?v=3ce10a4d"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Building Systems from Scratch" href="building_systems.html" />
    <link rel="prev" title="Getting Started with OpenMM" href="getting_started.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="nbsphinx-prolog">
    <a href="loading_and_reporting.ipynb">Download Notebook</a>
    <a href="https://github.com/openmm/openmm-cookbook/blob/main/notebooks/tutorials/loading_and_reporting.ipynb">View in GitHub</a>
    <a href="https://colab.research.google.com/github/openmm/openmm-cookbook/blob/gh-pages/dev/colab/notebooks/tutorials/loading_and_reporting.ipynb">Open in Google Colab</a>
</div><span class="target" id="index-0"></span><section id="Loading-Input-Files-and-Reporting-Results">
<h1>Loading Input Files and Reporting Results<a class="headerlink" href="#Loading-Input-Files-and-Reporting-Results" title="Link to this heading">¶</a></h1>
<section id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Link to this heading">¶</a></h2>
<p>In the previous tutorial in this series, we listed three primary methods for setting up and running simulations with OpenMM. We have already seen how to use OpenMM Setup to prepare a simulation from a Protein Data Bank structure and generate a Python script to run OpenMM. Here, we will consider the second method, and show how to use OpenMM to load input files prepared outside of OpenMM. We will also explore the various built-in options offered by OpenMM for reporting simulation results, and show
how to create custom reporting functions that can be registered with OpenMM. This tutorial assumes that you are familiar with the material in the previous tutorial and already have OpenMM and OpenMM Setup installed. If not, refer to <a class="reference internal" href="getting_started.html"><span class="doc">Getting Started with OpenMM</span></a> before returning here.</p>
<p>In this tutorial, we will use input files generated by the LEaP utility in AmberTools. Using LEaP or other features of AmberTools is out of the scope of the tutorial, and completing it does not require prior knowledge of these tools. However, you may consult the Amber <a class="reference external" href="https://ambermd.org/tutorials/">tutorials</a> or <a class="reference external" href="https://ambermd.org/Manuals.php">reference manuals</a> if you are looking for more information. As we will discuss, OpenMM provides very similar mechanisms for loading CHARMM,
Gromacs, and Tinker files, so you can easily adapt the instructions given here to these cases.</p>
</section>
<section id="Preparing-Input-Files">
<h2>Preparing Input Files<a class="headerlink" href="#Preparing-Input-Files" title="Link to this heading">¶</a></h2>
<p>Two kinds of Amber input files are needed to specify the initial state of a simulation: <em>prmtop</em> files specifying the atoms in a system and the interactions between them, and <em>inpcrd</em> files providing a set of initial coordinates. Compared with a PDB or PDBx/mmCIF file specifying atoms and their connectivity, a prmtop file contains all of the interaction parameters for bonds, angles, <em>etc.</em> in a system. As such, no separate force field files are needed when setting up a simulation from a prmtop.
Instead, you use a tool like LEaP to generate a prmtop from a description of a topology along with Amber force field data files. For this tutorial, as an example, we have used LEaP to create prmtop and inpcrd files for alanine dipeptide in water by running the following LEaP input script:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>source leaprc.protein.ff19SB
source leaprc.water.opc
chain = sequence { ACE ALA NME }
solvateoct chain OPCBOX 10
saveamberparm chain input.prmtop input.inpcrd
quit
</pre></div>
</div>
<p>This creates a single alanine dipeptide molecule, solvates it, and parameterizes it with the Amber ff19SB force field and the OPC water model. The output files, <code class="docutils literal notranslate"><span class="pre">input.prmtop</span></code> and <code class="docutils literal notranslate"><span class="pre">input.inpcrd</span></code>, are already provided with this tutorial, so it is not necessary to run LEaP yourself if you want to follow along. However, if you want to experiment with modifications to the input files, you could <a class="reference external" href="https://ambermd.org/GetAmber.php#ambertools">install AmberTools</a> and regenerate the files yourself
with a command like</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>tleap<span class="w"> </span>-f<span class="w"> </span>input.dat
</pre></div>
</div>
<p>after saving the above LEaP commands to a file <code class="docutils literal notranslate"><span class="pre">input.dat</span></code>, for instance.</p>
<p>We will again use OpenMM Setup to generate a starting input file. Since the previous tutorial covers <a class="reference internal" href="getting_started.html#Installing-OpenMM-and-Running-OpenMM-Setup"><span class="std std-ref">installing and running OpenMM Setup</span></a> in detail, we will not discuss it at length again. To work with Amber files in OpenMM Setup, simply choose the “Amber” option from the start page instead of the “PDB” option. Select your prmtop and inpcrd files when prompted. Since LEaP has already done all of the work of assigning force
field parameters, there are no further preparation steps required before OpenMM Setup generates an input script. For this example, we can keep the default options, except that we will equilibrate for 10,000 steps and run for only 100,000 steps. This will create a script that looks like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This script was generated by OpenMM-Setup on 2025-09-25.</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">openmm</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">openmm.app</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">openmm.unit</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="c1"># Input Files</span>

<span class="n">inpcrd</span> <span class="o">=</span> <span class="n">AmberInpcrdFile</span><span class="p">(</span><span class="s1">&#39;input.inpcrd&#39;</span><span class="p">)</span>
<span class="n">prmtop</span> <span class="o">=</span> <span class="n">AmberPrmtopFile</span><span class="p">(</span><span class="s1">&#39;input.prmtop&#39;</span><span class="p">,</span> <span class="n">periodicBoxVectors</span><span class="o">=</span><span class="n">inpcrd</span><span class="o">.</span><span class="n">boxVectors</span><span class="p">)</span>

<span class="c1"># System Configuration</span>

<span class="n">nonbondedMethod</span> <span class="o">=</span> <span class="n">PME</span>
<span class="n">nonbondedCutoff</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">nanometers</span>
<span class="n">constraints</span> <span class="o">=</span> <span class="n">HBonds</span>
<span class="n">rigidWater</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">constraintTolerance</span> <span class="o">=</span> <span class="mf">0.000001</span>
<span class="n">hydrogenMass</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">amu</span>
<span class="n">ewaldErrorTolerance</span> <span class="o">=</span> <span class="mf">0.0005</span>

<span class="c1"># Integration Options</span>

<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.004</span><span class="o">*</span><span class="n">picoseconds</span>
<span class="n">temperature</span> <span class="o">=</span> <span class="mi">300</span><span class="o">*</span><span class="n">kelvin</span>
<span class="n">friction</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">picosecond</span>
<span class="n">pressure</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">atmospheres</span>
<span class="n">barostatInterval</span> <span class="o">=</span> <span class="mi">25</span>

<span class="c1"># Simulation Options</span>

<span class="n">steps</span> <span class="o">=</span> <span class="mi">100000</span>
<span class="n">equilibrationSteps</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">dcdReporter</span> <span class="o">=</span> <span class="n">DCDReporter</span><span class="p">(</span><span class="s1">&#39;trajectory.dcd&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
<span class="n">dataReporter</span> <span class="o">=</span> <span class="n">StateDataReporter</span><span class="p">(</span><span class="s1">&#39;log.txt&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">totalSteps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span>
    <span class="n">step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">speed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">potentialEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">checkpointReporter</span> <span class="o">=</span> <span class="n">CheckpointReporter</span><span class="p">(</span><span class="s1">&#39;checkpoint.chk&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>

<span class="c1"># Prepare the Simulation</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Building system...&#39;</span><span class="p">)</span>
<span class="n">topology</span> <span class="o">=</span> <span class="n">prmtop</span><span class="o">.</span><span class="n">topology</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">inpcrd</span><span class="o">.</span><span class="n">positions</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">prmtop</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="n">nonbondedMethod</span><span class="o">=</span><span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="n">nonbondedCutoff</span><span class="p">,</span>
    <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span> <span class="n">rigidWater</span><span class="o">=</span><span class="n">rigidWater</span><span class="p">,</span> <span class="n">ewaldErrorTolerance</span><span class="o">=</span><span class="n">ewaldErrorTolerance</span><span class="p">,</span> <span class="n">hydrogenMass</span><span class="o">=</span><span class="n">hydrogenMass</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">MonteCarloBarostat</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">barostatInterval</span><span class="p">))</span>
<span class="n">integrator</span> <span class="o">=</span> <span class="n">LangevinMiddleIntegrator</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">friction</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
<span class="n">integrator</span><span class="o">.</span><span class="n">setConstraintTolerance</span><span class="p">(</span><span class="n">constraintTolerance</span><span class="p">)</span>
<span class="n">simulation</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">)</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>

<span class="c1"># Minimize and Equilibrate</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Performing energy minimization...&#39;</span><span class="p">)</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">minimizeEnergy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Equilibrating...&#39;</span><span class="p">)</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setVelocitiesToTemperature</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">equilibrationSteps</span><span class="p">)</span>

<span class="c1"># Simulate</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Simulating...&#39;</span><span class="p">)</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dcdReporter</span><span class="p">)</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataReporter</span><span class="p">)</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">checkpointReporter</span><span class="p">)</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">currentStep</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="The-Simulation-Script">
<h2>The Simulation Script<a class="headerlink" href="#The-Simulation-Script" title="Link to this heading">¶</a></h2>
<p>Let us examine the script generated by OpenMM Setup for these inputs. Some of the code should be familiar from the previous tutorial, and we will spend most of our time here explaining what is new, as well as making a few modifications. First, as before, we import names from OpenMM’s modules:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">openmm</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">openmm.app</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">openmm.unit</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
</div>
<section id="Input-Files">
<h3>Input Files<a class="headerlink" href="#Input-Files" title="Link to this heading">¶</a></h3>
<p>Now, instead of loading a PDBx/mmCIF file and an OpenMM force field, we first load the input coordinates in the inpcrd file, followed by the topology and parameter data in the prmtop file. This is done with OpenMM’s <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.amberinpcrdfile.AmberInpcrdFile.html">AmberInpcrdFile</a> and <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.amberprmtopfile.AmberPrmtopFile.html">AmberPrmtopFile</a> classes, respectively.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inpcrd</span> <span class="o">=</span> <span class="n">AmberInpcrdFile</span><span class="p">(</span><span class="s1">&#39;input.inpcrd&#39;</span><span class="p">)</span>
<span class="n">prmtop</span> <span class="o">=</span> <span class="n">AmberPrmtopFile</span><span class="p">(</span><span class="s1">&#39;input.prmtop&#39;</span><span class="p">,</span> <span class="n">periodicBoxVectors</span><span class="o">=</span><span class="n">inpcrd</span><span class="o">.</span><span class="n">boxVectors</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Note that we pass periodic box vectors loaded as the <code class="docutils literal notranslate"><span class="pre">boxVectors</span></code> attribute of the inpcrd file as a <code class="docutils literal notranslate"><span class="pre">periodicBoxVectors</span></code> argument to AmberPrmtopFile. Even though we do not need the position coordinates from the inpcrd file until we have already created an OpenMM Context, and the box vectors will fluctuate throughout the simulation if we add a barostat, it is necessary for OpenMM to know an <em>initial</em> set of box vectors when a Context is created. These initial vectors get passed through an
OpenMM System object that we will create later from the AmberPrmtopFile, so we need to provide them when creating the AmberPrmtopFile.</p>
</section>
<section id="Simulation-Parameters">
<h3>Simulation Parameters<a class="headerlink" href="#Simulation-Parameters" title="Link to this heading">¶</a></h3>
<p>Next, we define system parameters:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># System Configuration</span>

<span class="n">nonbondedMethod</span> <span class="o">=</span> <span class="n">PME</span>
<span class="n">nonbondedCutoff</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">nanometers</span>
<span class="n">constraints</span> <span class="o">=</span> <span class="n">HBonds</span>
<span class="n">rigidWater</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">constraintTolerance</span> <span class="o">=</span> <span class="mf">0.000001</span>
<span class="n">hydrogenMass</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">amu</span>
<span class="n">ewaldErrorTolerance</span> <span class="o">=</span> <span class="mf">0.0005</span>

<span class="c1"># Integration Options</span>

<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.004</span><span class="o">*</span><span class="n">picoseconds</span>
<span class="n">temperature</span> <span class="o">=</span> <span class="mi">300</span><span class="o">*</span><span class="n">kelvin</span>
<span class="n">friction</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">picosecond</span>
<span class="n">pressure</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">atmospheres</span>
<span class="n">barostatInterval</span> <span class="o">=</span> <span class="mi">25</span>

<span class="c1"># Simulation Options</span>

<span class="n">steps</span> <span class="o">=</span> <span class="mi">100000</span>
<span class="n">equilibrationSteps</span> <span class="o">=</span> <span class="mi">10000</span>
</pre></div>
</div>
</div>
<p>In the last tutorial, we saw how to use a <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.statedatareporter.StateDataReporter.html">StateDataReporter</a> to periodically write properties to an output file. Here, we explore a few other options for simulation output. The <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.dcdreporter.DCDReporter.html">DCDReporter</a> writes coordinates in the DCD format used by CHARMM and NAMD:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dcdReporter</span> <span class="o">=</span> <span class="n">DCDReporter</span><span class="p">(</span><span class="s1">&#39;trajectory.dcd&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>This reporter will write a frame to the <code class="docutils literal notranslate"><span class="pre">trajectory.dcd</span></code> file every 10,000 steps. Next, we have a StateDataReporter, writing to <code class="docutils literal notranslate"><span class="pre">log.txt</span></code> every 1,000 steps. The documentation describes <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.statedatareporter.StateDataReporter.html#openmm.app.statedatareporter.StateDataReporter.__init__">a number of options</a> to control the output, most of which are selectable within OpenMM Setup.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataReporter</span> <span class="o">=</span> <span class="n">StateDataReporter</span><span class="p">(</span><span class="s1">&#39;log.txt&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">totalSteps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span>
    <span class="n">step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">speed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">potentialEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Finally, we have a <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.checkpointreporter.CheckpointReporter.html">CheckpointReporter</a>, which saves the current state of the simulation to a file periodically. Here, <code class="docutils literal notranslate"><span class="pre">checkpoint.chk</span></code> will be updated every 10,000 steps:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">checkpointReporter</span> <span class="o">=</span> <span class="n">CheckpointReporter</span><span class="p">(</span><span class="s1">&#39;checkpoint.chk&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>When a new checkpoint is written, it overwrites the last checkpoint. Checkpoints can be reloaded manually by using <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.simulation.Simulation.html#openmm.app.simulation.Simulation.loadCheckpoint">Simulation.loadCheckpoint()</a>. Note that by default, checkpoints are specific not only to the System that they are associated with, but also the hardware on which the simulation runs, and the version of OpenMM used. Saving a checkpoint on one
machine and loading it on another may fail.</p>
</section>
<section id="Preparing-the-Simulation">
<h3>Preparing the Simulation<a class="headerlink" href="#Preparing-the-Simulation" title="Link to this heading">¶</a></h3>
<p>We can now retrieve the OpenMM Topology object and initial positions used to set up our simulation. The Topology comes from the AmberPrmtopFile and the positions come from the AmberInpcrdFile.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">topology</span> <span class="o">=</span> <span class="n">prmtop</span><span class="o">.</span><span class="n">topology</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">inpcrd</span><span class="o">.</span><span class="n">positions</span>
</pre></div>
</div>
</div>
<p>We can now create a System object. Compared to the <a class="reference internal" href="getting_started.html#Preparing-the-Simulation"><span class="std std-ref">previous tutorial</span></a> where we used a ForceField to create the system from a Topology, the options that OpenMM accepts at this stage are the same. However, we now create the System directly from the AmberPrmtopFile, with its own <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.amberprmtopfile.AmberPrmtopFile.html#openmm.app.amberprmtopfile.AmberPrmtopFile.createSystem">createSystem()
method</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">system</span> <span class="o">=</span> <span class="n">prmtop</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="n">nonbondedMethod</span><span class="o">=</span><span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="n">nonbondedCutoff</span><span class="p">,</span>
    <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span> <span class="n">rigidWater</span><span class="o">=</span><span class="n">rigidWater</span><span class="p">,</span> <span class="n">ewaldErrorTolerance</span><span class="o">=</span><span class="n">ewaldErrorTolerance</span><span class="p">,</span> <span class="n">hydrogenMass</span><span class="o">=</span><span class="n">hydrogenMass</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We set up a barostat for pressure control, and create an integrator for Langevin dynamics for temperature control:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">MonteCarloBarostat</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">barostatInterval</span><span class="p">))</span>
<span class="n">integrator</span> <span class="o">=</span> <span class="n">LangevinMiddleIntegrator</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">friction</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
<span class="n">integrator</span><span class="o">.</span><span class="n">setConstraintTolerance</span><span class="p">(</span><span class="n">constraintTolerance</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We create a Simulation, and initialize the positions and velocities of its Context:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">simulation</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">)</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">minimizeEnergy</span><span class="p">()</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setVelocitiesToTemperature</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Again, we are ready to run simulation steps:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">simulation</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">equilibrationSteps</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="Customizing-Output">
<h2>Customizing Output<a class="headerlink" href="#Customizing-Output" title="Link to this heading">¶</a></h2>
<p>As before, we can add all of the Reporter objects we have created to the Simulation. Before they are added to the Simulation’s list of reporters, they will not produce any output. Once they are added, subsequent simulation steps will result in output.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dcdReporter</span><span class="p">)</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataReporter</span><span class="p">)</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">checkpointReporter</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We could follow the script generated by OpenMM Setup and call <code class="docutils literal notranslate"><span class="pre">simulation.step(steps)</span></code> at this point. However, we may want to go beyond the output capabilities given by the builtin reporter classes supported by OpenMM Setup. To do this, we first need to understand how OpenMM manages simulation data. If you explore the documentation for the <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.openmm.Context.html">Context</a> class, you will notice methods like
<a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.openmm.Context.html#openmm.openmm.Context.setPositions">setPositions()</a> and <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.openmm.Context.html#openmm.openmm.Context.setVelocities">setVelocities()</a> that make it easy to <em>update</em> the state of a simulation, but you will not find matching get…() methods to pull the same data back out of a Context. Instead, you must call
<a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.openmm.Context.html#openmm.openmm.Context.getState">Context.getState()</a>, specifying the data you want, and OpenMM will return it in a <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.openmm.State.html">State</a> object. For instance, to get positions of all of the atoms and the forces on them, you could call:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">state</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">positions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">forces</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The data retrieved in the State can now be accessed with various methods:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">state</span><span class="o">.</span><span class="n">getPositions</span><span class="p">(</span><span class="n">asNumpy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[1.50107098 1.29423523 1.61434221]
 [1.60019267 1.32622433 1.64647591]
 [1.66838324 1.30488992 1.56416011]
 ...
 [0.78152287 2.89071155 0.24455565]
 [0.88193351 2.98365092 0.23549855]
 [0.8570745  2.90930557 0.23497924]] nm
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">state</span><span class="o">.</span><span class="n">getForces</span><span class="p">(</span><span class="n">asNumpy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[  -38.89948071  -153.96918255   424.43393552]
 [  858.82813192  -463.77030713  -305.10929128]
 [ -161.65399572   474.8532923     -4.92390516]
 ...
 [ -683.19337306   316.79597489    87.27160007]
 [  110.67214027   843.57635569    37.60505555]
 [ 1052.04823148 -1607.92052856   -69.53699802]] kJ/(nm mol)
</pre></div></div>
</div>
<p>There are two things to keep in mind when retrieving a State from an OpenMM Context. First, except for <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.openmm.State.html#openmm.openmm.State.getPeriodicBoxVectors">State.getPeriodicBoxVectors()</a>, <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.openmm.State.html#openmm.openmm.State.getPeriodicBoxVolume">State.getPeriodicBoxVolume()</a>,
<a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.openmm.State.html#openmm.openmm.State.getStepCount">State.getStepCount()</a>, and <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.openmm.State.html#openmm.openmm.State.getTime">State.getTime()</a>, you must explicitly request that data be retrieved by passing the appropriate arguments to <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.openmm.Context.html#openmm.openmm.Context.getState">Context.getState()</a>
(<em>e.g.</em>, <code class="docutils literal notranslate"><span class="pre">positions=True</span></code>, <code class="docutils literal notranslate"><span class="pre">forces=True</span></code>) before you can access it in the State returned. For instance, trying to call <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.openmm.State.html#openmm.openmm.State.getVelocities">State.getVelocities()</a> on the object we have just created will raise an exception, since we did not set <code class="docutils literal notranslate"><span class="pre">velocities=True</span></code> when calling Context.getState().</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">state</span><span class="o">.</span><span class="n">getVelocities</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">OpenMMException</span>                           Traceback (most recent call last)
<span class="ansi-green-fg">/tmp/ipykernel_12183/4278095083.py</span> in <span class="ansi-cyan-fg">?</span><span class="ansi-blue-fg">()</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">1</span> state.getVelocities()

<span class="ansi-green-fg">~/miniforge3/envs/ommcookbook/lib/python3.13/site-packages/openmm/openmm.py</span> in <span class="ansi-cyan-fg">?</span><span class="ansi-blue-fg">(self, asNumpy)</span>
<span class="ansi-green-fg">   8650</span>                 self._getVectorAsNumpy(State.Velocities, self._velocitiesNumpy)
<span class="ansi-green-fg">   8651</span>                 self._velocitiesNumpy = self._velocitiesNumpy*unit.nanometers/unit.picosecond
<span class="ansi-green-fg">   8652</span>             <span class="ansi-bold" style="color: rgb(0,135,0)">return</span> self._velocitiesNumpy
<span class="ansi-green-fg">   8653</span>         <span class="ansi-bold" style="color: rgb(0,135,0)">if</span> <span class="ansi-yellow-fg">&#39;_velocities&#39;</span> <span class="ansi-bold" style="color: rgb(0,135,0)">not</span> <span class="ansi-bold" style="color: rgb(0,135,0)">in</span> dir(self):
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">8654</span>             self._velocities = self._getVectorAsVec3(State.Velocities)*unit.nanometers/unit.picosecond
<span class="ansi-green-fg">   8655</span>         <span class="ansi-bold" style="color: rgb(0,135,0)">return</span> self._velocities

<span class="ansi-green-fg">~/miniforge3/envs/ommcookbook/lib/python3.13/site-packages/openmm/openmm.py</span> in <span class="ansi-cyan-fg">?</span><span class="ansi-blue-fg">(self, type)</span>
<span class="ansi-green-fg">   8679</span>     <span class="ansi-bold" style="color: rgb(0,135,0)">def</span> _getVectorAsVec3(self, type):
<span class="ansi-green-fg">   8680</span>         <span class="ansi-yellow-fg">r&#34;&#34;&#34;_getVectorAsVec3(self, type) -&gt; PyObject *&#34;&#34;&#34;</span>
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">8681</span>         <span class="ansi-bold" style="color: rgb(0,135,0)">return</span> _openmm.State__getVectorAsVec3(self, type)

<span class="ansi-red-fg">OpenMMException</span>: Invoked getVelocities() on a State which does not contain velocities.
</pre></div></div>
</div>
<p>Second, a State behaves as a snapshot of a certain point in the simulation. If we run additional simulation steps, a State object generated beforehand will not reflect the new state of the simulation:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">simulation</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">state</span><span class="o">.</span><span class="n">getPositions</span><span class="p">(</span><span class="n">asNumpy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[1.50107098 1.29423523 1.61434221]
 [1.60019267 1.32622433 1.64647591]
 [1.66838324 1.30488992 1.56416011]
 ...
 [0.78152287 2.89071155 0.24455565]
 [0.88193351 2.98365092 0.23549855]
 [0.8570745  2.90930557 0.23497924]] nm
</pre></div></div>
</div>
<p>Looking above, we can see that these position coordinates have not changed, but if we create a new State, it will have different coordinates corresponding to the new state of the simulation after the steps we just ran.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">positions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">getPositions</span><span class="p">(</span><span class="n">asNumpy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[1.48028743 1.36690414 1.57390463]
 [1.50051606 1.37272763 1.68085277]
 [1.57415998 1.29589057 1.70438266]
 ...
 [0.78769583 2.86549401 0.37170982]
 [0.90120202 2.88162613 0.44693035]
 [0.82367676 2.87156415 0.44109282]] nm
</pre></div></div>
</div>
<section id="Writing-Custom-Reporters">
<h3>Writing Custom Reporters<a class="headerlink" href="#Writing-Custom-Reporters" title="Link to this heading">¶</a></h3>
<p>Now that you know how to obtain the state of a simulation, you can in principle perform any kind of analysis or output at regular intervals during a simulation, just by using <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.simulation.Simulation.html#openmm.app.simulation.Simulation.step">Simulation.step()</a> and <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.openmm.Context.html#openmm.openmm.Context.getState">Context.getState()</a> in a loop. However, it is
relatively straightforward to write a custom reporter class that you can register with a Simulation, just like OpenMM’s builtin reporters.</p>
<p>As a simple example, we will suppose that we are interested in periodically recording the center of mass of the dipeptide in our simulation. This can of course be done using a library like <a class="reference external" href="https://www.mdtraj.org/">MDTraj</a> or <a class="reference external" href="https://www.mdanalysis.org/">MDAnalysis</a> to read a DCD or other trajectory file written by one of OpenMM’s builtin reporters. This example is primarily for illustrative purposes, although the reporter we will create could be useful if you wish to run, <em>e.g.</em>, a very
long simulation to study the diffusion of a molecule in solution, and want to avoid consuming excessive disk space with a trajectory containing all of its atomic positions.</p>
<p>If we have a State object containing positions, along with a list of atom indices, and the masses of the atoms, finding the center of mass is as simple as:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_com_nm</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">masses</span><span class="p">):</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPositions</span><span class="p">(</span><span class="n">asNumpy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">nanometer</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">masses</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">positions</span><span class="p">[</span><span class="n">indices</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">masses</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>In the first tutorial, we mentioned that OpenMM’s Python API accepts quantities with units. You may have noticed that the arrays of positions printed above look like NumPy arrays, but they have units of <code class="docutils literal notranslate"><span class="pre">nm</span></code> attached. They are actually <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.unit.quantity.Quantity.html">Quantity</a> instances; to access underlying NumPy arrays without units, we can use
<a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.unit.quantity.Quantity.html#openmm.unit.quantity.Quantity.value_in_unit">Quantity.value_in_unit()</a> to generate values in any (dimensionally consistent) units of our choice.</p>
<p>To allow OpenMM to call this function periodically, we can write a reporter class. There is no base class to inherit from; simply provide a class with describeNextReport() and report() methods:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">class</span><span class="w"> </span><span class="nc">COMReporter</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">reportInterval</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="c1"># OpenMM does not manage the output file(s); reporters have full control over this.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reportInterval</span> <span class="o">=</span> <span class="n">reportInterval</span>

        <span class="c1"># Save the indices given and look up the atom masses with System.getParticleMass().</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_masses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">system</span><span class="o">.</span><span class="n">getParticleMass</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">dalton</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">describeNextReport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation</span><span class="p">):</span>
        <span class="c1"># Calculate the number of steps to the next report, if reports should happen at multiples of reportInterval steps.</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reportInterval</span> <span class="o">-</span> <span class="n">simulation</span><span class="o">.</span><span class="n">currentStep</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reportInterval</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">],</span> <span class="n">periodic</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">compute_com_nm</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_masses</span><span class="p">)</span>

        <span class="c1"># Do any kind of reporting.  We flush the file to make sure that a new line is written immediately.</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">12.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s2">12.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">z</span><span class="si">:</span><span class="s2">12.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>The describeNextReport() method should take a Simulation object, and return a dictionary with a few fields informing OpenMM about the next report that the reporter wants to make. The <code class="docutils literal notranslate"><span class="pre">steps</span></code> key should specify the number of steps remaining before the next report should be made. The <code class="docutils literal notranslate"><span class="pre">include</span></code> key gives a list of the data items that should be included in a State that will be created for our reporter by OpenMM. Here, <code class="docutils literal notranslate"><span class="pre">periodic=False</span></code> tells OpenMM not to apply periodic boundary conditions to
the position coordinates (we will not discuss this at length here, but the <a class="reference external" href="https://docs.openmm.org/latest/userguide/theory/05_other_features.html#periodic-boundary-conditions">user guide</a> and <a class="reference external" href="https://github.com/openmm/openmm/wiki/Frequently-Asked-Questions#periodic">Frequently Asked Questions</a> have more information about how periodic boundary conditions work in OpenMM). A complete description of what describeNextReport() can return to OpenMM is given in the <a class="reference external" href="https://docs.openmm.org/latest/userguide/application/04_advanced_sim_examples.html#extracting-and-reporting-forces-and-other-data">user
guide</a>. OpenMM will process this information and automatically call the reporter’s report() method when appropriate, with the Simulation object, as well as a State constructed according to our specifications.</p>
<p>Finally, we can register an instance of this reporter class with OpenMM, and run some simulation steps. We need to retrieve the indices of the atoms in the dipeptide first, which we can do with the Topology loaded from the prmtop file. To get the indices we need, we can find the residues associated with our dipeptide and iterate over their atoms. It turns out that the first three residues contain the sequence of the peptide that we instructed LEaP to build:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">residues</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">topology</span><span class="o">.</span><span class="n">residues</span><span class="p">())[:</span><span class="mi">3</span><span class="p">]</span>
<span class="n">residues</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;Residue 0 (ACE) of chain 0&gt;,
 &lt;Residue 1 (ALA) of chain 0&gt;,
 &lt;Residue 2 (NME) of chain 0&gt;]
</pre></div></div>
</div>
<p>We will explore the features of Topology objects more comprehensively in the next tutorial. For now, all we need after using <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.topology.Topology.html#openmm.app.topology.Topology.residues">Topology.residues()</a> is to extract the indices with <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.topology.Residue.html#openmm.app.topology.Residue.atoms">Residue.atoms()</a> and
<a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.topology.Atom.html">Atom.index</a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">residues</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">residue</span><span class="o">.</span><span class="n">atoms</span><span class="p">()]</span>
<span class="n">indices</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]
</pre></div></div>
</div>
<p>We can then create an instance of our custom reporter, attach it to the Simulation, and run:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">COMReporter</span><span class="p">(</span><span class="s2">&quot;com.txt&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">indices</span><span class="p">))</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>If we load this file and plot its contents, we can see the motion of the dipeptide:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">com_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s2">&quot;com.txt&quot;</span><span class="p">)</span>

<span class="n">figure</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;constrained&quot;</span><span class="p">)</span>

<span class="n">axes</span> <span class="o">=</span> <span class="n">figure</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s2">&quot;3d&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">com_pos</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$x$ (nm)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$y$ (nm)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;$z$ (nm)&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_loading_and_reporting_53_0.png" src="../../_images/notebooks_tutorials_loading_and_reporting_53_0.png" />
</div>
</div>
</section>
</section>
<section id="Summary-and-Further-Reading">
<h2>Summary and Further Reading<a class="headerlink" href="#Summary-and-Further-Reading" title="Link to this heading">¶</a></h2>
<p>After following this tutorial, you should be able to:</p>
<ul class="simple">
<li><p>Set up an OpenMM simulation using Amber input files</p></li>
<li><p>Retrieve and access the state of an OpenMM simulation as it runs</p></li>
<li><p>Use OpenMM’s builtin reporter classes to output simulation results, and write your own custom reporters</p></li>
</ul>
<p>You may want to load input files from a molecular dynamics program other than Amber. For <a class="reference external" href="https://academiccharmm.org/">CHARMM</a>, you will need a PSF file with structure information, a CRD file with coordinates, and then force field files in CHARMM’s RTF (residue topology), PRM (parameters), and/or STR (stream file) formats. These files can be loaded into OpenMM like</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">psf</span> <span class="o">=</span> <span class="n">CharmmPsfFile</span><span class="p">(</span><span class="s1">&#39;input.psf&#39;</span><span class="p">)</span>
<span class="n">crd</span> <span class="o">=</span> <span class="n">CharmmCrdFile</span><span class="p">(</span><span class="s1">&#39;input.crd&#39;</span><span class="p">)</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">CharmmParameterSet</span><span class="p">(</span><span class="s1">&#39;input.prm&#39;</span><span class="p">,</span> <span class="s1">&#39;input.rtf&#39;</span><span class="p">,</span> <span class="s1">&#39;input.str&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="c1"># Include as many files as needed</span>
</pre></div>
</div>
<p>A Topology, positions, and a System can then be created like</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">topology</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">topology</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">crd</span><span class="o">.</span><span class="n">positions</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="c1"># Include options here</span>
</pre></div>
</div>
<p>For <a class="reference external" href="https://www.gromacs.org/">GROMACS</a>, you will need a GRO file with coordinates, a TOP file with topology information, and a path to a directory with include files. These can be loaded as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">gro</span> <span class="o">=</span> <span class="n">GromacsGroFile</span><span class="p">(</span><span class="s1">&#39;input.gro&#39;</span><span class="p">)</span>
<span class="n">top</span> <span class="o">=</span> <span class="n">GromacsTopFile</span><span class="p">(</span><span class="s1">&#39;input.top&#39;</span><span class="p">,</span> <span class="n">includeDir</span><span class="o">=</span><span class="s1">&#39;/path/to/gromacs/share/gromacs/top&#39;</span><span class="p">,</span>
    <span class="n">periodicBoxVectors</span><span class="o">=</span><span class="n">gro</span><span class="o">.</span><span class="n">getPeriodicBoxVectors</span><span class="p">())</span>
</pre></div>
</div>
<p>and the Topology, positions, and System created as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">topology</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="n">topology</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">gro</span><span class="o">.</span><span class="n">positions</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="c1"># Include options here</span>
</pre></div>
</div>
<p>OpenMM can also load <a class="reference external" href="https://dasher.wustl.edu/tinker/">Tinker</a> and <a class="reference external" href="https://www.schrodinger.com/platform/products/desmond/">Desmond</a> files through the <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.tinkerfiles.TinkerFiles.html">TinkerFiles</a> (requires OpenMM 8.4 or later) and <a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.desmonddmsfile.DesmondDMSFile.html">DesmondDMSFile</a> APIs, respectively.</p>
</section>
<section id="Links">
<h2>Links<a class="headerlink" href="#Links" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>Relevant sections of the <a class="reference external" href="https://docs.openmm.org/latest/api-python/">User Guide</a>:</p>
<ul>
<li><p><a class="reference external" href="https://docs.openmm.org/latest/userguide/application/02_running_sims.html">Running Simulations</a></p>
<ul>
<li><p><a class="reference external" href="https://docs.openmm.org/latest/userguide/application/02_running_sims.html#using-amber-files">Using AMBER Files</a></p></li>
<li><p><a class="reference external" href="https://docs.openmm.org/latest/userguide/application/02_running_sims.html#using-gromacs-files">Using Gromacs Files</a></p></li>
<li><p><a class="reference external" href="https://docs.openmm.org/latest/userguide/application/02_running_sims.html#using-charmm-files">Using CHARMM Files</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://docs.openmm.org/latest/userguide/application/04_advanced_sim_examples.html#extracting-and-reporting-forces-and-other-data">Extracting and Reporting Forces (and other data)</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://docs.openmm.org/latest/api-python/">Python API documentation</a> pages for new classes introduced in this tutorial:</p>
<ul>
<li><p><a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.amberinpcrdfile.AmberInpcrdFile.html">AmberInpcrdFile</a></p></li>
<li><p><a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.amberprmtopfile.AmberPrmtopFile.html">AmberPrmtopFile</a></p></li>
<li><p><a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.charmmcrdfiles.CharmmCrdFile.html">CharmmCrdFile</a></p></li>
<li><p><a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.charmmparameterset.CharmmParameterSet.html">CharmmParameterSet</a></p></li>
<li><p><a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.charmmpsffile.CharmmPsfFile.html">CharmmPsfFile</a></p></li>
<li><p><a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.checkpointreporter.CheckpointReporter.html">CheckpointReporter</a></p></li>
<li><p><a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.dcdreporter.DCDReporter.html">DCDReporter</a></p></li>
<li><p><a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.gromacsgrofile.GromacsGroFile.html">GromacsGroFile</a></p></li>
<li><p><a class="reference external" href="https://docs.openmm.org/latest/api-python/generated/openmm.app.gromacstopfile.GromacsTopFile.html">GromacsTopFile</a></p></li>
</ul>
</li>
</ul>
</section>
</section>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="getting_started.html" title="Previous document">Getting Started with OpenMM</a>
        </li>
        <li>
          <a href="building_systems.html" title="Next document">Building Systems from Scratch</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo.svg" alt="Logo" />
    
    <h1 class="logo logo-name">OpenMM Cookbook & Tutorials</h1>
    
  </a>
</p>











<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><div class="navigation-scrollbox">
    <div class="nav-toctree">
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../cookbook.html">The OpenMM Cookbook</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../tutorials.html">The OpenMM Tutorials</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../tutorials.html#getting-started">Getting Started</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="getting_started.html">Getting Started with OpenMM</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Loading Input Files and Reporting Results</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Preparing-Input-Files">Preparing Input Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#The-Simulation-Script">The Simulation Script</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Customizing-Output">Customizing Output</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Summary-and-Further-Reading">Summary and Further Reading</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Links">Links</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="building_systems.html">Building Systems from Scratch</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials.html#beyond-the-basics">Beyond the Basics</a></li>
</ul>
</li>
</ul>

    </div>
    
    <ul class="extra-nav-links">
        
        <li class="toctree-l1">
            <a href="https://openmm.org">
                OpenMM.org
            </a>
        </li>
        
        <li class="toctree-l1">
            <a href="https://docs.openmm.org/latest/userguide/">
                User's Manual
            </a>
        </li>
        
        <li class="toctree-l1">
            <a href="https://docs.openmm.org/latest/developerguide/">
                Developer Guide
            </a>
        </li>
        
        <li class="toctree-l1">
            <a href="https://docs.openmm.org/latest/api-c++/">
                C++ API reference
            </a>
        </li>
        
        <li class="toctree-l1">
            <a href="https://docs.openmm.org/latest/api-python/">
                Python API reference
            </a>
        </li>
        
        <li class="toctree-l1">
            <a href="https://github.com/openmm/openmm">
                GitHub
            </a>
        </li>
        
    </ul>
    
</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, The OpenMM Contributors.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../../_sources/notebooks/tutorials/loading_and_reporting.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>